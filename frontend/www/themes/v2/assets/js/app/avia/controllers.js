// Generated by CoffeeScript 1.3.3
var AviaController, SearchParams, sp,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

SearchParams = (function() {

  function SearchParams() {
    this.dep = 'MOW';
    this.arr = 'PAR';
    this.date = '02.10.2012';
    this.rt = false;
    this.rt_date = '12.10.2012';
  }

  SearchParams.prototype.url = function() {
    var params, result;
    result = 'http://api.misha.voyanga/v1/flight/search/withParams?';
    params = [];
    params.push('destinations[0][departure]=' + this.dep);
    params.push('destinations[0][arrival]=' + this.arr);
    params.push('destinations[0][date]=' + this.date);
    if (this.rt) {
      params.push('destinations[1][departure]=' + this.arr);
      params.push('destinations[1][arrival]=' + this.dep);
      params.push('destinations[1][date]=' + this.rt_date);
    }
    return result += params.join("&");
  };

  SearchParams.prototype.key = function() {
    var key;
    key = this.dep + this.arr + this.date;
    if (this.rt) {
      key += this.rt_date;
    }
    return key;
  };

  return SearchParams;

})();

sp = new SearchParams;

AviaController = (function() {

  function AviaController() {
    this.indexAction = __bind(this.indexAction, this);

    this.searchAction = __bind(this.searchAction, this);
    this.routes = {
      '/search/{from}/{to}/{when}/': this.searchAction,
      '': this.indexAction
    };
  }

  AviaController.prototype.searchAction = function() {
    if (sessionStorage.getItem("search_" + sp.key())) {
      return this.handleResults(JSON.parse(sessionStorage.getItem("search_" + sp.key())));
    } else {
      return $.ajax({
        url: sp.url(),
        dataType: 'jsonp',
        success: this.handleResults
      });
    }
  };

  AviaController.prototype.handleResults = function(data) {
    var stacked;
    sessionStorage.setItem("search_" + sp.key(), JSON.stringify(data));
    return stacked = new ResultSet(data.flights.flightVoyages);
  };

  AviaController.prototype.indexAction = function() {
    return this.searchAction();
  };

  return AviaController;

})();
