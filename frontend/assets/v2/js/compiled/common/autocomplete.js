// Generated by CoffeeScript 1.4.0
var _this = this;

ko.bindingHandlers.autocomplete = {
  init: function(element, valueAccessor) {
    $(element).focus(function() {
      this.select();
      return this.setSelectionRange(0, 9999);
    }).mouseup(function(e) {
      return e.preventDefault();
    });
    $(element).typeahead({
      name: 'cities' + valueAccessor().name,
      limit: 5,
      prefetch: '/js/cities.json',
      remote: window.apiEndPoint + "helper/autocomplete/" + valueAccessor().source + '/query/%QUERY',
      template: '<div title="{{value}}"><span class="city">{{name}}, </span><span class="country">{{country}}</span><span class="code">{{code}}</span></div>',
      engine: Hogan
    });
    $(element).on('typeahead:selected typeahead:autocompleted', function(e, data) {
      var city, dataset, ind, _i, _len, _ref;
      voyanga_debug('allinone', $(element).data(), data, e);
      dataset = $(element).data('ttView').datasets[0];
      if (data.t === 2) {
        _ref = data.aviaIds;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          ind = _ref[_i];
          city = dataset.itemHash[dataset.uniqFindId(ind, '/js/cities.json')].datum;
          console.log('avia in place', ind, dataset.uniqFindId(ind, '/js/cities.json'), city);
        }
      }
      valueAccessor().iata(data.code);
      valueAccessor().readable(data.name);
      valueAccessor().readableGen(data.nameGen);
      valueAccessor().readableAcc(data.nameAcc);
      valueAccessor().readablePre(data.namePre);
      $(element).val(data.name);
      $(element).parent().siblings('input.input-path').val(data.value + ', ' + data.country);
      if ((!$(element).is('.arrivalCity')) && ($('input.arrivalCity').length > 0)) {
        return $('input.arrivalCity.second-path').focus();
      } else {
        return $(element).blur();
      }
    });
    $(element).on('typeahead:over', function(e, data) {
      return $(element).parent().siblings('input.input-path').val(data.value + ', ' + data.country);
    });
    return $(element).on('typeahead:reset', function(e) {
      $(element).parent().siblings('input.input-path').val('');
      valueAccessor().iata('');
      valueAccessor().readable('');
      valueAccessor().readableGen('');
      valueAccessor().readableAcc('');
      return valueAccessor().readablePre('');
    });
  },
  update: function(element, valueAccessor) {
    var content, iataCode;
    iataCode = valueAccessor().iata();
    content = valueAccessor().readable();
    if (content === void 0) {
      content = iataCode;
    }
    return _.each($(element).typeahead("setQueryInternal", content).data('ttView').datasets, function(dataset) {
      return dataset.getSuggestions(iataCode, function(s) {
        if (s.length > 0) {
          return _.each(s, function(s) {
            var data;
            if (s.datum.code === iataCode) {
              data = s.datum;
              valueAccessor().readable(data.name);
              valueAccessor().readableGen(data.nameGen);
              valueAccessor().readableAcc(data.nameAcc);
              valueAccessor().readablePre(data.namePre);
              if (($(element).val().length === 0) || ($(element).val() !== data.name)) {
                $(element).val(data.name);
                return $(element).parent().siblings('input.input-path').val(data.value + ', ' + data.country);
              }
            }
          });
        }
      });
    });
  }
};
