// Generated by CoffeeScript 1.4.0
var GenericPopup,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

GenericPopup = (function() {

  function GenericPopup(id, data, modal) {
    var el;
    this.id = id;
    this.modal = modal != null ? modal : false;
    this.zindex = __bind(this.zindex, this);

    this.close = __bind(this.close, this);

    this.rebind = __bind(this.rebind, this);

    if (!window.popupStack) {
      window.popupStack = [];
    }
    this.inside = false;
    if (window.popupStack.length === 0) {
      $('body').css('overflow', 'hidden');
    }
    this.overlay = $('<div id="popupOverlay" style="z-index:' + this.zindex() + '"></div>');
    $('body').prepend(this.overlay);
    el = $(this.id + '-template');
    if (el[0] === void 0) {
      throw "Wrong popup template";
      return;
    }
    this.el = $(el.html());
    $('body').prepend(this.el);
    this.el.css('z-index', this.zindex());
    ko.applyBindings({
      data: data,
      close: this.close
    }, this.el[0]);
    ko.processAllDeferredBindingUpdates();
    if (this.modal) {
      return;
    }
    window.popupStack.push(this);
    this.rebind();
  }

  GenericPopup.prototype.rebind = function() {
    var _this = this;
    $(window).unbind('keyup');
    $(window).keyup(function(e) {
      if (e.keyCode === 27) {
        console.error(_this);
        return _this.close();
      }
    });
    $(this.el.find('table')[0] || this.el.find('.wrapContent')).hover(function() {
      return _this.inside = true;
    }, function() {
      return _this.inside = false;
    });
    return this.el.click(function() {
      if (!_this.inside) {
        return _this.close();
      }
    });
  };

  GenericPopup.prototype.close = function() {
    if (!this.modal) {
      $(window).unbind('keyup');
    }
    this.el.remove();
    this["this"] = window.popupStack.pop();
    this.overlay.remove();
    if (window.popupStack.length) {
      return window.popupStack[window.popupStack.length - 1].rebind();
    } else {
      return $('body').css('overflow', 'auto');
    }
  };

  GenericPopup.prototype.zindex = function() {
    if (!window.POPUP_NEXT_ZINDEX) {
      window.POPUP_NEXT_ZINDEX = 2000;
    }
    return window.POPUP_NEXT_ZINDEX++;
  };

  return GenericPopup;

})();
