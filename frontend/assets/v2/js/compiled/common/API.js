// Generated by CoffeeScript 1.4.0
var API, AviaAPI, HotelsAPI, ToursAPI, VisualLoader,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  __slice = [].slice,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

API = (function() {

  function API() {
    this.call = __bind(this.call, this);
    this.endpoint = window.apiEndPoint;
  }

  API.prototype.call = function(url, cb, showLoad) {
    var _this = this;
    if (showLoad == null) {
      showLoad = true;
    }
    if (showLoad) {
      $('#loadWrapBg').show();
      loaderChange(true);
    }
    return $.ajax({
      url: "" + this.endpoint + url,
      dataType: 'json',
      timeout: 200000,
      success: function(data) {
        cb(data);
        if (showLoad) {
          $('#loadWrapBg').hide();
          return loaderChange(false);
        }
      },
      error: function() {
        var jqXHR, rest;
        jqXHR = arguments[0], rest = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
        if (showLoad) {
          $('#loadWrapBg').hide();
          loaderChange(false);
        }
        throw new Error(("Api call failed: Url: " + url) + " | Status: " + jqXHR.status + " | Status text '" + jqXHR.statusText + "' | " + jqXHR.getAllResponseHeaders().replace("\n", ";") + " | " + rest.join(" | "));
      }
    });
  };

  return API;

})();

ToursAPI = (function(_super) {

  __extends(ToursAPI, _super);

  function ToursAPI() {
    this.search = __bind(this.search, this);
    return ToursAPI.__super__.constructor.apply(this, arguments);
  }

  ToursAPI.prototype.search = function(url, cb) {
    return this.call(url, function(data) {
      return cb(data);
    });
  };

  return ToursAPI;

})(API);

AviaAPI = (function(_super) {

  __extends(AviaAPI, _super);

  function AviaAPI() {
    this.search = __bind(this.search, this);
    return AviaAPI.__super__.constructor.apply(this, arguments);
  }

  AviaAPI.prototype.search = function(url, cb) {
    return this.call(url, function(data) {
      return cb(data);
    });
  };

  return AviaAPI;

})(API);

HotelsAPI = (function(_super) {

  __extends(HotelsAPI, _super);

  function HotelsAPI() {
    this.search = __bind(this.search, this);
    return HotelsAPI.__super__.constructor.apply(this, arguments);
  }

  HotelsAPI.prototype.search = function(url, cb, showLoad) {
    if (showLoad == null) {
      showLoad = true;
    }
    return this.call(url, function(data) {
      return cb(data);
    }, showLoad);
  };

  return HotelsAPI;

})(API);

VisualLoader = (function() {

  function VisualLoader() {
    this.start = __bind(this.start, this);

    this.renew = __bind(this.renew, this);

    var _this = this;
    this.percents = ko.observable(0);
    this.separator = 90;
    this.separatedTime = 30;
    this.timeoutHandler = null;
    this.description = ko.observable('');
    this.timeFromStart = 0;
    this.percents.subscribe(function(newVal) {
      return console.log('loder changed... NOW: ' + newVal + '% time from start: ' + _this.timeFromStart + 'sec');
    });
  }

  VisualLoader.prototype.renew = function(percent) {
    var newPerc, rand, rtime,
      _this = this;
    this.percents(percent);
    if ((98 > percent && percent >= 0)) {
      rand = Math.random();
      if (percent < 90) {
        rtime = Math.ceil(rand * (this.separatedTime / 3));
        newPerc = Math.ceil(rand * (this.separator / 3));
        if (newPerc > 3) {
          newPerc = newPerc + Math.ceil((newPerc / 10) * (Math.random() - 0.5));
        }
      } else {
        rtime = Math.ceil(rand * (this.separatedTime / 3));
        newPerc = Math.ceil(Math.random() * 2);
      }
      console.log('time: ' + rtime + 'sec');
      this.timeFromStart += rtime;
      return this.timeoutHandler = window.setTimeout(function() {
        return _this.renew(percent + newPerc);
      }, 1000 * rtime);
    } else if ((100 > percent && percent >= 98)) {
      return console.log('loadrer more 98');
    } else {
      if (this.timeoutHandler) {
        window.clearTimeout(this.timeoutHandler);
      }
      return this.timeoutHandler = null;
    }
  };

  VisualLoader.prototype.start = function(description) {
    this.description(description);
    this.timeFromStart = 0;
    return this.renew(0);
  };

  return VisualLoader;

})();
